# v1.5.5 更新内容詳細

## リリース日: 2025-10-20

---

## 📋 概要

v1.5.5では、システム部管理機能の大幅な強化を行いました。特に操作ログの詳細記録、バックアップからの復元機能、CSVインポート時のユーザーエクスペリエンス向上に注力しています。

---

## 🆕 主要な変更点

### 1. 📊 操作ログ機能の強化

システム部が行う全ての操作を詳細に記録するようになりました。

#### 記録される操作
- ✅ **訂正依頼のロック/ロック解除**
  - 操作者、操作日時、対象レコードIDを記録
- ✅ **CSVエクスポート**
  - エクスポートしたテーブル名、件数を記録
- ✅ **CSVインポート**
  - インポートしたテーブル名、件数を記録
  - データ削除操作も記録
- ✅ **バックアップ復元**
  - 復元したバックアップファイル名を記録
- ✅ **バックアップ一覧表示**
  - バックアップ一覧の表示操作を記録

#### メリット
- システム部の操作が完全に追跡可能
- 問題発生時の原因追及が容易
- 監査証跡として活用可能

---

### 2. 💾 バックアップ管理機能の追加

新しく「バックアップ管理」タブを追加しました。

#### 主な機能
- **📋 バックアップ一覧表示**
  - ファイル名、作成日時、サイズ、パスを表示
  - 新しい順に自動ソート

- **🔄 更新ボタン**
  - バックアップ一覧を最新の状態に更新

- **📥 バックアップからの復元**
  - 選択したバックアップからデータベースを復元
  - 復元前に現在のデータベースを緊急バックアップとして自動保存
  - 復元後はアプリケーションの再起動を推奨

#### 復元手順
1. バックアップ管理タブを開く
2. 復元したいバックアップを選択
3. 「選択したバックアップを読み込む」ボタンをクリック
4. 確認ダイアログで「はい」を選択
5. 完了メッセージを確認
6. アプリケーションを再起動

#### 安全機能
- 復元前に緊急バックアップ自動作成
- 確認ダイアログで誤操作を防止
- 詳細ログに復元操作を記録

---

### 3. 📚 講座情報管理の改善

講座情報のCSV入出力を最適化しました。

#### CSVエクスポートの変更
**変更前:**
```csv
講座ID,講座名,担当教員,年度,学期,科目コード
2025-0142Z01,現代の国語ａ①,棚橋 麻美,2025,通年,0142Z01
```

**変更後:**
```csv
講座名,担当教員,年度,学期,科目コード
現代の国語ａ①,棚橋 麻美,2025,通年,0142Z01
```

#### 理由
- 講座IDは「年度-科目コード」から自動生成可能
- エクスポートファイルがシンプルになり、管理しやすい
- データの二重管理を避けられる

#### CSVインポートの動作
- インポート時に講座IDを自動生成: `{年度}-{科目コード}`
- 例: 年度=2025、科目コード=0142Z01 → 講座ID=2025-0142Z01

#### メリット
- CSVファイルの可読性向上
- データ整合性の自動保証
- 手動入力ミスの防止

---

### 4. ⏳ プログレスバーの追加

大量データのインポート時に進捗状況を視覚的に表示するようになりました。

#### 対象操作
- 生徒情報CSVインポート
- 講座情報CSVインポート
- 訂正依頼CSVインポート

#### 表示内容
- 「書き込み中...」メッセージ
- 進捗バー（0〜100%）
- 処理済み件数 / 総件数
- キャンセルボタン（処理中断可能）

#### メリット
- 処理中であることが明確
- 完了までの見通しが立つ
- 応答なし状態との区別が可能
- 必要に応じて処理を中断できる

---

## 🔧 技術的な詳細

### 操作ログの実装

```python
# システム部管理の操作をログに記録
self.log_controller.log_operation(
    operation_type='ロック',
    target_table='correction_requests',
    target_record_id=correction_id,
    detail='訂正依頼をロック（システム部管理）'
)
```

### バックアップ復元の実装

```python
def restore_backup(self, backup_path: Path) -> bool:
    # 現在のDBをバックアップ
    if self.db_path.exists():
        emergency_backup = self.db_path.parent / f"{self.db_path.stem}_emergency.db"
        shutil.copy2(self.db_path, emergency_backup)
    
    # 復元
    shutil.copy2(backup_path, self.db_path)
    return True
```

### プログレスバーの実装

```python
progress = QProgressDialog("書き込み中...", "キャンセル", 0, len(rows), self)
progress.setWindowModality(Qt.WindowModal)
progress.setWindowTitle("インポート中")
progress.setMinimumDuration(0)

for i, row in enumerate(rows):
    if progress.wasCanceled():
        break
    # データ処理
    progress.setValue(i + 1)
    QApplication.processEvents()

progress.close()
```

---

## 📝 使用方法

### バックアップからの復元

1. **システム部管理タブを開く**
   - 「🔧 システム部管理」タブをクリック
   - パスワードを入力して認証

2. **バックアップ管理タブを選択**
   - 「💾 バックアップ管理」サブタブをクリック

3. **バックアップ一覧を確認**
   - 必要に応じて「🔄 更新」ボタンをクリック

4. **復元するバックアップを選択**
   - 一覧から目的のバックアップをクリック

5. **復元を実行**
   - 「📥 選択したバックアップを読み込む」ボタンをクリック
   - 確認ダイアログで「はい」を選択

6. **アプリケーションを再起動**
   - 完了メッセージを確認後、アプリを再起動

### 講座情報のCSVインポート

1. **CSVファイルを準備**
   ```csv
   講座名,担当教員,年度,学期,科目コード
   現代の国語ａ①,棚橋 麻美,2025,通年,0142Z01
   ```
   - 講座ID列は不要（自動生成されます）

2. **システム部管理でインポート**
   - 「📚 講座情報管理」タブを開く
   - 「📥 CSVインポート（差替え）」ボタンをクリック
   - CSVファイルを選択

3. **プログレスバーで進捗確認**
   - 「書き込み中...」ダイアログが表示される
   - 進捗バーで処理状況を確認

4. **完了メッセージを確認**
   - インポート件数が表示される

---

## ⚠️ 注意事項

### バックアップ復元について
- 復元すると現在のデータベースが上書きされます
- 復元前に自動的に緊急バックアップが作成されます
- 復元後は必ずアプリケーションを再起動してください

### CSVインポートについて
- インポートは既存データを全て削除して置き換えます
- 大量データの場合、処理に時間がかかる場合があります
- プログレスバーでキャンセル可能ですが、中断すると不完全な状態になります

### 講座IDについて
- 講座IDは「年度-科目コード」形式で自動生成されます
- CSVエクスポートファイルには講座ID列は含まれません
- 既存のCSVファイル（講座ID列あり）もそのまま利用可能です

---

## 🐛 既知の問題

現時点で既知の問題はありません。

---

## 📞 サポート

問題が発生した場合は、以下を確認してください：

1. **操作ログを確認**
   - システム部管理 → 操作ログタブ
   - 最近の操作履歴を確認

2. **バックアップから復元**
   - バックアップ管理タブから最新のバックアップを復元

3. **開発者に報告**
   - エラーメッセージのスクリーンショット
   - 操作ログのエクスポート
   - 発生した手順の詳細

---

## 📚 関連ドキュメント

- [README.md](../README.md) - アプリケーション概要
- [CHANGELOG.md](../CHANGELOG.md) - 変更履歴一覧
- [02_データベース設計.md](./02_データベース設計.md) - DB構造

---

## 🎯 今後の予定

今後のバージョンで以下の機能を検討中：

- バックアップの自動復元ポイント設定
- 操作ログのフィルタリング機能強化
- CSVインポート時のデータ検証機能
- 複数バックアップの一括管理機能

---

**開発:** seyaytua  
**バージョン:** 1.5.5  
**リリース日:** 2025-10-20
