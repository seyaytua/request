
訂正依頼システム - データベース設計
データベース概要
DBMS: SQLite 3.x
ファイル名: corrections.db
配置場所: 実行ファイルと同じディレクトリ（共有サーバー）
文字コード: UTF-8
照合順序: NOCASE（大文字小文字を区別しない）

ER図
┌─────────────────┐
│    students     │
│  (生徒情報)     │
└────────┬────────┘
         │ 1
         │
         │ N
┌────────▼────────────────────────────────────┐
│       correction_requests                  │
│       (訂正依頼)                           │
└────────┬───────────────────────────────────┘
         │ N
         │
         │ 1
┌────────▼────────┐
│    courses      │
│   (講座情報)    │
└─────────────────┘

         ┌─────────────────┐
         │ operation_logs  │
         │  (操作ログ)     │
         └─────────────────┘

         ┌─────────────────┐
         │ system_settings │
         │ (システム設定)  │
         └─────────────────┘
テーブル定義
1. students（生徒情報テーブル）
目的: 訂正依頼の対象となる生徒の基本情報を管理

CopyCREATE TABLE students (
    student_id INTEGER PRIMARY KEY AUTOINCREMENT,
    year INTEGER NOT NULL,                      -- 年度（例: 2025）
    class_number TEXT NOT NULL,                 -- 組番号（例: "1-A", "2-3"）
    student_number TEXT,                        -- 出席番号
    name TEXT NOT NULL,                         -- 氏名
    name_kana TEXT,                             -- ふりがな
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(year, class_number, student_number)
);
カラム詳細
カラム名	型	NULL	デフォルト	説明
student_id	INTEGER	NO	AUTO	主キー
year	INTEGER	NO	-	年度（4桁）
class_number	TEXT	NO	-	組番号
student_number	TEXT	YES	-	出席番号
name	TEXT	NO	-	氏名
name_kana	TEXT	YES	-	ふりがな
created_at	TIMESTAMP	NO	現在時刻	作成日時
updated_at	TIMESTAMP	NO	現在時刻	更新日時
インデックス
CopyCREATE INDEX idx_students_year_class ON students(year, class_number);
CREATE INDEX idx_students_name ON students(name);
サンプルデータ
CopyINSERT INTO students (year, class_number, student_number, name, name_kana) VALUES
(2025, '1-A', '01', '山田太郎', 'やまだたろう'),
(2025, '1-A', '02', '佐藤花子', 'さとうはなこ'),
(2025, '2-B', '15', '鈴木一郎', 'すずきいちろう');
2. courses（講座情報テーブル）
目的: 訂正依頼の対象となる講座の基本情報を管理

CopyCREATE TABLE courses (
    course_id TEXT PRIMARY KEY,                 -- 講座ID（例: "2025-MATH-101"）
    course_name TEXT NOT NULL,                  -- 講座名
    teacher_name TEXT,                          -- 担当教員
    year INTEGER NOT NULL,                      -- 年度
    semester INTEGER,                           -- 学期（1,2,3）
    subject_code TEXT,                          -- 科目コード
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
カラム詳細
カラム名	型	NULL	デフォルト	説明
course_id	TEXT	NO	-	主キー（講座ID）
course_name	TEXT	NO	-	講座名
teacher_name	TEXT	YES	-	担当教員
year	INTEGER	NO	-	年度
semester	INTEGER	YES	-	学期
subject_code	TEXT	YES	-	科目コード
created_at	TIMESTAMP	NO	現在時刻	作成日時
updated_at	TIMESTAMP	NO	現在時刻	更新日時
インデックス
CopyCREATE INDEX idx_courses_year ON courses(year);
CREATE INDEX idx_courses_name ON courses(course_name);
サンプルデータ
CopyINSERT INTO courses (course_id, course_name, teacher_name, year, semester, subject_code) VALUES
('2025-MATH-101', '数学I', '田中先生', 2025, 1, 'MATH'),
('2025-ENG-201', '英語II', '佐々木先生', 2025, 1, 'ENG'),
('2025-SCI-301', '理科III', '伊藤先生', 2025, 2, 'SCI');
3. correction_requests（訂正依頼テーブル）
目的: 出欠訂正・評価評定変更の依頼を管理（メインテーブル）

CopyCREATE TABLE correction_requests (
    correction_id INTEGER PRIMARY KEY AUTOINCREMENT,
    request_type TEXT NOT NULL CHECK(request_type IN ('出欠訂正', '評価評定変更')),
    student_id INTEGER NOT NULL,
    course_id TEXT NOT NULL,
    target_date TEXT,                           -- 対象日付（出欠訂正の場合、YYYY-MM-DD形式）
    semester INTEGER,                           -- 学期（評価評定変更の場合）
    before_value TEXT,                          -- 訂正前の値
    after_value TEXT,                           -- 訂正後の値
    reason TEXT NOT NULL,                       -- 理由
    requester_name TEXT NOT NULL,               -- 依頼者名（PCユーザー名）
    requester_pc TEXT NOT NULL,                 -- PC名
    request_datetime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_locked BOOLEAN DEFAULT 0,                -- ロック状態（0: 未ロック, 1: ロック済み）
    locked_by TEXT,                             -- ロックした人
    locked_datetime TIMESTAMP,                  -- ロック日時
    status TEXT DEFAULT '未処理' CHECK(status IN ('未処理', '処理中', '完了')),
    is_deleted BOOLEAN DEFAULT 0,               -- 削除フラグ（0: 有効, 1: 削除済み）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (student_id) REFERENCES students(student_id),
    FOREIGN KEY (course_id) REFERENCES courses(course_id)
);
カラム詳細
カラム名	型	NULL	デフォルト	説明
correction_id	INTEGER	NO	AUTO	主キー
request_type	TEXT	NO	-	出欠訂正/評価評定変更
student_id	INTEGER	NO	-	生徒ID（FK）
course_id	TEXT	NO	-	講座ID（FK）
target_date	TEXT	YES	-	対象日付（出欠訂正）
semester	INTEGER	YES	-	学期（評価評定変更）
before_value	TEXT	YES	-	訂正前の値
after_value	TEXT	YES	-	訂正後の値
reason	TEXT	NO	-	理由
requester_name	TEXT	NO	-	依頼者名
requester_pc	TEXT	NO	-	PC名
request_datetime	TIMESTAMP	NO	現在時刻	依頼日時
is_locked	BOOLEAN	NO	0	ロック状態
locked_by	TEXT	YES	-	ロックした人
locked_datetime	TIMESTAMP	YES	-	ロック日時
status	TEXT	NO	未処理	処理状態
is_deleted	BOOLEAN	NO	0	削除フラグ
created_at	TIMESTAMP	NO	現在時刻	作成日時
updated_at	TIMESTAMP	NO	現在時刻	更新日時
インデックス
CopyCREATE INDEX idx_corrections_student ON correction_requests(student_id);
CREATE INDEX idx_corrections_course ON correction_requests(course_id);
CREATE INDEX idx_corrections_status ON correction_requests(status, is_locked);
CREATE INDEX idx_corrections_date ON correction_requests(target_date);
CREATE INDEX idx_corrections_requester ON correction_requests(requester_name);
CREATE INDEX idx_corrections_deleted ON correction_requests(is_deleted);
before_value / after_value の形式
出欠訂正の場合
before_value: "出席", "欠席", "遅刻", "早退"
after_value: "出席", "欠席", "遅刻", "早退"
評価評定変更の場合
before_value: "評価:A, 評定:8"
after_value: "評価:B, 評定:7"
サンプルデータ
Copy-- 出欠訂正
INSERT INTO correction_requests 
(request_type, student_id, course_id, target_date, before_value, after_value, reason, requester_name, requester_pc)
VALUES
('出欠訂正', 1, '2025-MATH-101', '2025-10-15', '欠席', '出席', '体調不良で欠席扱いだったが、後日診断書提出', 'tanaka_user', 'PC-STAFF-01');

-- 評価評定変更
INSERT INTO correction_requests 
(request_type, student_id, course_id, semester, before_value, after_value, reason, requester_name, requester_pc)
VALUES
('評価評定変更', 2, '2025-ENG-201', 1, '評価:B, 評定:7', '評価:A, 評定:9', 'レポート再評価により変更', 'sasaki_user', 'PC-STAFF-02');
4. operation_logs（操作ログテーブル）
目的: 全ての操作履歴を記録し、監査証跡を残す

CopyCREATE TABLE operation_logs (
    log_id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL,                     -- PCユーザー名
    pc_name TEXT NOT NULL,                      -- PC名
    operation_type TEXT NOT NULL,               -- 操作種別
    target_table TEXT NOT NULL,                 -- 対象テーブル名
    target_record_id INTEGER,                   -- 対象レコードID
    before_data TEXT,                           -- 変更前データ（JSON形式）
    after_data TEXT,                            -- 変更後データ（JSON形式）
    operation_detail TEXT,                      -- 操作詳細
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
カラム詳細
カラム名	型	NULL	デフォルト	説明
log_id	INTEGER	NO	AUTO	主キー
username	TEXT	NO	-	PCユーザー名
pc_name	TEXT	NO	-	PC名
operation_type	TEXT	NO	-	作成/更新/削除/ロック/ロック解除
target_table	TEXT	NO	-	対象テーブル名
target_record_id	INTEGER	YES	-	対象レコードID
before_data	TEXT	YES	-	変更前データ（JSON）
after_data	TEXT	YES	-	変更後データ（JSON）
operation_detail	TEXT	YES	-	操作詳細
timestamp	TIMESTAMP	NO	現在時刻	タイムスタンプ
インデックス
CopyCREATE INDEX idx_logs_timestamp ON operation_logs(timestamp DESC);
CREATE INDEX idx_logs_username ON operation_logs(username);
CREATE INDEX idx_logs_operation ON operation_logs(operation_type);
CREATE INDEX idx_logs_target ON operation_logs(target_table, target_record_id);
operation_type の値
作成 - 新規レコード作成
更新 - レコード更新
削除 - レコード削除（論理削除）
ロック - 訂正依頼のロック
ロック解除 - 訂正依頼のロック解除
認証成功 - システム部管理へのログイン成功
認証失敗 - システム部管理へのログイン失敗
サンプルデータ
CopyINSERT INTO operation_logs 
(username, pc_name, operation_type, target_table, target_record_id, after_data, operation_detail)
VALUES
('tanaka_user', 'PC-STAFF-01', '作成', 'correction_requests', 1, 
 '{"request_type": "出欠訂正", "student_id": 1, "course_id": "2025-MATH-101"}',
 '訂正依頼を新規作成');
5. system_settings（システム設定テーブル）
目的: システム全体の設定を管理（パスワードなど）

CopyCREATE TABLE system_settings (
    setting_key TEXT PRIMARY KEY,
    setting_value TEXT NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
カラム詳細
カラム名	型	NULL	デフォルト	説明
setting_key	TEXT	NO	-	設定キー（主キー）
setting_value	TEXT	NO	-	設定値
updated_at	TIMESTAMP	NO	現在時刻	更新日時
初期データ
Copy-- パスワード: admin123 のSHA256ハッシュ
INSERT INTO system_settings (setting_key, setting_value) VALUES
('admin_password_hash', '240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9');
管理する設定
setting_key	説明	初期値
admin_password_hash	システム部管理パスワード（SHA256）	admin123のハッシュ
app_version	アプリバージョン	1.0.0
db_version	DBバージョン	1.0
データベース初期化SQL
Copy-- schema.sql
PRAGMA foreign_keys = ON;
PRAGMA journal_mode = WAL;

-- 生徒情報テーブル
CREATE TABLE IF NOT EXISTS students (
    student_id INTEGER PRIMARY KEY AUTOINCREMENT,
    year INTEGER NOT NULL,
    class_number TEXT NOT NULL,
    student_number TEXT,
    name TEXT NOT NULL,
    name_kana TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(year, class_number, student_number)
);

CREATE INDEX IF NOT EXISTS idx_students_year_class ON students(year, class_number);
CREATE INDEX IF NOT EXISTS idx_students_name ON students(name);

-- 講座情報テーブル
CREATE TABLE IF NOT EXISTS courses (
    course_id TEXT PRIMARY KEY,
    course_name TEXT NOT NULL,
    teacher_name TEXT,
    year INTEGER NOT NULL,
    semester INTEGER,
    subject_code TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_courses_year ON courses(year);
CREATE INDEX IF NOT EXISTS idx_courses_name ON courses(course_name);

-- 訂正依頼テーブル
CREATE TABLE IF NOT EXISTS correction_requests (
    correction_id INTEGER PRIMARY KEY AUTOINCREMENT,
    request_type TEXT NOT NULL CHECK(request_type IN ('出欠訂正', '評価評定変更')),
    student_id INTEGER NOT NULL,
    course_id TEXT NOT NULL,
    target_date TEXT,
    semester INTEGER,
    before_value TEXT,
    after_value TEXT,
    reason TEXT NOT NULL,
    requester_name TEXT NOT NULL,
    requester_pc TEXT NOT NULL,
    request_datetime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_locked BOOLEAN DEFAULT 0,
    locked_by TEXT,
    locked_datetime TIMESTAMP,
    status TEXT DEFAULT '未処理' CHECK(status IN ('未処理', '処理中', '完了')),
    is_deleted BOOLEAN DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (student_id) REFERENCES students(student_id),
    FOREIGN KEY (course_id) REFERENCES courses(course_id)
);

CREATE INDEX IF NOT EXISTS idx_corrections_student ON correction_requests(student_id);
CREATE INDEX IF NOT EXISTS idx_corrections_course ON correction_requests(course_id);
CREATE INDEX IF NOT EXISTS idx_corrections_status ON correction_requests(status, is_locked);
CREATE INDEX IF NOT EXISTS idx_corrections_date ON correction_requests(target_date);
CREATE INDEX IF NOT EXISTS idx_corrections_requester ON correction_requests(requester_name);
CREATE INDEX IF NOT EXISTS idx_corrections_deleted ON correction_requests(is_deleted);

-- 操作ログテーブル
CREATE TABLE IF NOT EXISTS operation_logs (
    log_id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL,
    pc_name TEXT NOT NULL,
    operation_type TEXT NOT NULL,
    target_table TEXT NOT NULL,
    target_record_id INTEGER,
    before_data TEXT,
    after_data TEXT,
    operation_detail TEXT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_logs_timestamp ON operation_logs(timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_logs_username ON operation_logs(username);
CREATE INDEX IF NOT EXISTS idx_logs_operation ON operation_logs(operation_type);
CREATE INDEX IF NOT EXISTS idx_logs_target ON operation_logs(target_table, target_record_id);

-- システム設定テーブル
CREATE TABLE IF NOT EXISTS system_settings (
    setting_key TEXT PRIMARY KEY,
    setting_value TEXT NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 初期パスワード: admin123
INSERT OR IGNORE INTO system_settings (setting_key, setting_value) VALUES
('admin_password_hash', '240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9'),
('app_version', '1.0.0'),
('db_version', '1.0');
トランザクション設計
訂正依頼作成時
CopyBEGIN TRANSACTION;

-- 1. 訂正依頼を挿入
INSERT INTO correction_requests (...) VALUES (...);

-- 2. 操作ログを記録
INSERT INTO operation_logs (...) VALUES (...);

COMMIT;
訂正依頼更新時
CopyBEGIN TRANSACTION;

-- 1. 変更前データを取得
SELECT * FROM correction_requests WHERE correction_id = ?;

-- 2. 訂正依頼を更新
UPDATE correction_requests SET ... WHERE correction_id = ?;

-- 3. 操作ログを記録（変更前後のデータを含む）
INSERT INTO operation_logs (...) VALUES (...);

COMMIT;
バックアップ戦略
自動バックアップ
毎日深夜2時に自動バックアップ
バックアップファイル名: corrections_backup_YYYYMMDD.db
保存先: \\shared-server\App_request\backups\
保持期間: 30日
手動バックアップ
システム部管理画面から実行可能
ファイル名を指定して保存
更新履歴
日付	バージョン	更新内容	担当者
2025-10-17	1.0	初版作成	-
EOF			


