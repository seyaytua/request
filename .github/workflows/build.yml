name: Build Windows Executable

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executable
      run: |
        pyinstaller --onefile --windowed --name="訂正依頼システム" --icon=src/resources/icons/app.ico main.py
    
    - name: Create release archive
      run: |
        mkdir release
        copy dist\訂正依頼システム.exe release\
        mkdir release\data
        echo "初回起動時に自動的にデータベースが作成されます" > release\data\README.txt
    
    - name: Get version
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      shell: bash
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: 訂正依頼システム-${{ steps.get_version.outputs.VERSION }}
        path: release/
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/訂正依頼システム.exe
        body: |
          ## 訂正依頼システム ${{ steps.get_version.outputs.VERSION }}
          
          ### ダウンロード
          - Windows用実行ファイル: `訂正依頼システム.exe`
          
          ### インストール方法
          1. `訂正依頼システム.exe` をダウンロード
          2. 任意のフォルダに配置
          3. ダブルクリックで起動
          
          ### 初回起動時
          - 自動的に `data` フォルダとデータベースが作成されます
          - 管理者パスワード: `admin123`（変更推奨）
          
          ### 主な機能
          - 出欠訂正・評価評定変更の依頼管理
          - 自動バックアップ機能
          - 生徒名・講座名検索（ひらがな対応）
          - CSVエクスポート/インポート
          
          ### システム要件
          - OS: Windows 10/11
          - メモリ: 4GB以上推奨
          
          ### 詳細な変更内容
          [CHANGELOG.md](https://github.com/seyaytua/request/blob/main/CHANGELOG.md) を参照してください。
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
