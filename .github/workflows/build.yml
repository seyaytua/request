name: Build Executables

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Windows executable
      run: |
        pyinstaller --clean --onefile --windowed ^
          --name=CorrectionRequestSystem ^
          --add-data="src;src" ^
          main.py
      shell: cmd
    
    - name: Create Windows package
      run: |
        mkdir portable
        copy dist\CorrectionRequestSystem.exe portable\訂正依頼システム.exe
        mkdir portable\data
        echo 訂正依頼システム v${{ github.ref_name }} - Windows版 > portable\README.txt
        echo. >> portable\README.txt
        echo 使い方: >> portable\README.txt
        echo 1. 訂正依頼システム.exe をダブルクリックで起動 >> portable\README.txt
        echo 2. 初回起動時に data フォルダにデータベースが自動作成されます >> portable\README.txt
        echo 3. 管理者パスワード: admin123 >> portable\README.txt
      shell: cmd
        
    - name: Create Windows ZIP
      run: Compress-Archive -Path portable\* -DestinationPath CorrectionRequestSystem-${{ github.ref_name }}-Windows.zip
      shell: pwsh
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-package
        path: CorrectionRequestSystem-${{ github.ref_name }}-Windows.zip

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build macOS executable
      run: |
        pyinstaller --clean --onefile --windowed \
          --name=CorrectionRequestSystem \
          --add-data="src:src" \
          main.py
    
    - name: Create macOS package
      run: |
        mkdir -p portable
        cp dist/CorrectionRequestSystem portable/訂正依頼システム
        chmod +x portable/訂正依頼システム
        mkdir -p portable/data
        cat > portable/README.txt << 'READMEEOF'
        訂正依頼システム v${{ github.ref_name }} - macOS版
        
        使い方:
        1. ターミナルで以下を実行:
           chmod +x 訂正依頼システム
           ./訂正依頼システム
        
        2. または、右クリック → 開く で起動
        
        3. 管理者パスワード: admin123
        
        注意:
        - 初回起動時に「開発元を確認できません」と表示される場合:
          右クリック → 開く で起動してください
        READMEEOF
    
    - name: Create macOS ZIP
      run: |
        cd portable
        zip -r ../CorrectionRequestSystem-${{ github.ref_name }}-macOS.zip .
        cd ..
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-package
        path: CorrectionRequestSystem-${{ github.ref_name }}-macOS.zip

  create-release:
    name: Create Release
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download Windows package
      uses: actions/download-artifact@v4
      with:
        name: windows-package
    
    - name: Download macOS package
      uses: actions/download-artifact@v4
      with:
        name: macos-package
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          CorrectionRequestSystem-${{ github.ref_name }}-Windows.zip
          CorrectionRequestSystem-${{ github.ref_name }}-macOS.zip
        body: |
          ## 📦 訂正依頼システム ${{ github.ref_name }}
          
          ### 📥 ダウンロード
          
          #### 🪟 Windows版
          `CorrectionRequestSystem-${{ github.ref_name }}-Windows.zip`
          
          #### 🍎 macOS版
          `CorrectionRequestSystem-${{ github.ref_name }}-macOS.zip`
          
          ### 🚀 インストール
          
          **Windows**: 解凍して `訂正依頼システム.exe` を起動
          
          **macOS**: 解凍して右クリック → 開く で起動
          
          ### 📋 初回起動
          
          管理者パスワード: `admin123` (必ず変更してください)
          
          ### ✨ 主な機能
          
          - 出欠訂正・評価評定変更の依頼管理
          - 自動バックアップ
          - 生徒名・講座名検索（ひらがな対応）
          - CSV入出力
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
