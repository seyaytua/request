name: Build Executables

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Windows executable
      run: |
        pyinstaller --clean --onefile --windowed ^
          --name=CorrectionRequestSystem ^
          --add-data="src;src" ^
          main.py
      shell: cmd
    
    - name: Create Windows package
      run: |
        mkdir portable
        copy dist\CorrectionRequestSystem.exe portable\è¨‚æ­£ä¾é ¼ã‚·ã‚¹ãƒ†ãƒ .exe
        mkdir portable\data
        echo è¨‚æ­£ä¾é ¼ã‚·ã‚¹ãƒ†ãƒ  v${{ github.ref_name }} - Windowsç‰ˆ > portable\README.txt
        echo. >> portable\README.txt
        echo ä½¿ã„æ–¹: >> portable\README.txt
        echo 1. è¨‚æ­£ä¾é ¼ã‚·ã‚¹ãƒ†ãƒ .exe ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§èµ·å‹• >> portable\README.txt
        echo 2. åˆå›žèµ·å‹•æ™‚ã« data ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ >> portable\README.txt
        echo 3. ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: admin123 >> portable\README.txt
      shell: cmd
        
    - name: Create Windows ZIP
      run: Compress-Archive -Path portable\* -DestinationPath CorrectionRequestSystem-${{ github.ref_name }}-Windows.zip
      shell: pwsh
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-package
        path: CorrectionRequestSystem-${{ github.ref_name }}-Windows.zip

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build macOS executable
      run: |
        pyinstaller --clean --onefile --windowed \
          --name=CorrectionRequestSystem \
          --add-data="src:src" \
          main.py
    
    - name: Create macOS package
      run: |
        mkdir -p portable
        cp dist/CorrectionRequestSystem portable/è¨‚æ­£ä¾é ¼ã‚·ã‚¹ãƒ†ãƒ 
        chmod +x portable/è¨‚æ­£ä¾é ¼ã‚·ã‚¹ãƒ†ãƒ 
        mkdir -p portable/data
        cat > portable/README.txt << 'READMEEOF'
        è¨‚æ­£ä¾é ¼ã‚·ã‚¹ãƒ†ãƒ  v${{ github.ref_name }} - macOSç‰ˆ
        
        ä½¿ã„æ–¹:
        1. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:
           chmod +x è¨‚æ­£ä¾é ¼ã‚·ã‚¹ãƒ†ãƒ 
           ./è¨‚æ­£ä¾é ¼ã‚·ã‚¹ãƒ†ãƒ 
        
        2. ã¾ãŸã¯ã€å³ã‚¯ãƒªãƒƒã‚¯ â†’ é–‹ã ã§èµ·å‹•
        
        3. ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: admin123
        
        æ³¨æ„:
        - åˆå›žèµ·å‹•æ™‚ã«ã€Œé–‹ç™ºå…ƒã‚’ç¢ºèªã§ãã¾ã›ã‚“ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹å ´åˆ:
          å³ã‚¯ãƒªãƒƒã‚¯ â†’ é–‹ã ã§èµ·å‹•ã—ã¦ãã ã•ã„
        READMEEOF
    
    - name: Create macOS ZIP
      run: |
        cd portable
        zip -r ../CorrectionRequestSystem-${{ github.ref_name }}-macOS.zip .
        cd ..
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-package
        path: CorrectionRequestSystem-${{ github.ref_name }}-macOS.zip

  create-release:
    name: Create Release
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download Windows package
      uses: actions/download-artifact@v4
      with:
        name: windows-package
    
    - name: Download macOS package
      uses: actions/download-artifact@v4
      with:
        name: macos-package
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          CorrectionRequestSystem-${{ github.ref_name }}-Windows.zip
          CorrectionRequestSystem-${{ github.ref_name }}-macOS.zip
        body: |
          ## ðŸ“¦ è¨‚æ­£ä¾é ¼ã‚·ã‚¹ãƒ†ãƒ  ${{ github.ref_name }}
          
          ### ðŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          
          #### ðŸªŸ Windowsç‰ˆ
          `CorrectionRequestSystem-${{ github.ref_name }}-Windows.zip`
          
          #### ðŸŽ macOSç‰ˆ
          `CorrectionRequestSystem-${{ github.ref_name }}-macOS.zip`
          
          ### ðŸš€ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          
          **Windows**: è§£å‡ã—ã¦ `è¨‚æ­£ä¾é ¼ã‚·ã‚¹ãƒ†ãƒ .exe` ã‚’èµ·å‹•
          
          **macOS**: è§£å‡ã—ã¦å³ã‚¯ãƒªãƒƒã‚¯ â†’ é–‹ã ã§èµ·å‹•
          
          ### ðŸ“‹ åˆå›žèµ·å‹•
          
          ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: `admin123` (å¿…ãšå¤‰æ›´ã—ã¦ãã ã•ã„)
          
          ### âœ¨ ä¸»ãªæ©Ÿèƒ½
          
          - å‡ºæ¬ è¨‚æ­£ãƒ»è©•ä¾¡è©•å®šå¤‰æ›´ã®ä¾é ¼ç®¡ç†
          - è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          - ç”Ÿå¾’åãƒ»è¬›åº§åæ¤œç´¢ï¼ˆã²ã‚‰ãŒãªå¯¾å¿œï¼‰
          - CSVå…¥å‡ºåŠ›
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
